/*							airy.c
 *
 *	Airy function
 *
 *
 *
 * SYNOPSIS:
 *
 * double x, ai, aip, bi, bip;
 * int airy();
 *
 * airy( x, _&ai, _&aip, _&bi, _&bip );
 *
 *
 *
 * DESCRIPTION:
 *
 * Solution of the differential equation
 *
 *	y"(x) = xy.
 *
 * The function returns the two independent solutions Ai, Bi
 * and their first derivatives Ai'(x), Bi'(x).
 *
 * Evaluation is by power series summation for small x,
 * by rational minimax approximations for large x.
 *
 *
 *
 * ACCURACY:
 * Error criterion is absolute when function <= 1, relative
 * when function > 1, except * denotes relative error criterion.
 * For large negative x, the absolute error increases as x^1.5.
 * For large positive x, the relative error increases as x^1.5.
 *
 * Arithmetic  domain   function  # trials      peak         rms
 * IEEE        -10, 0     Ai        10000       1.6e-15     2.7e-16
 * IEEE          0, 10    Ai        10000       2.3e-14*    1.8e-15*
 * IEEE        -10, 0     Ai'       10000       4.6e-15     7.6e-16
 * IEEE          0, 10    Ai'       10000       1.8e-14*    1.5e-15*
 * IEEE        -10, 10    Bi        30000       4.2e-15     5.3e-16
 * IEEE        -10, 10    Bi'       30000       4.9e-15     7.3e-16
 * DEC         -10, 0     Ai         5000       1.7e-16     2.8e-17
 * DEC           0, 10    Ai         5000       2.1e-15*    1.7e-16*
 * DEC         -10, 0     Ai'        5000       4.7e-16     7.8e-17
 * DEC           0, 10    Ai'       12000       1.8e-15*    1.5e-16*
 * DEC         -10, 10    Bi        10000       5.5e-16     6.8e-17
 * DEC         -10, 10    Bi'        7000       5.3e-16     8.7e-17
 *
 */
/*							airy.c */

/*
 * Cephes Math Library Release 2.8:  June, 2000
 * Copyright 1984, 1987, 1989, 2000 by Stephen L. Moshier
 */

#include "mconf.h"

static double c1 = 0.35502805388781723926;
static double c2 = 0.258819403792806798405;
static double sqrt3 = 1.732050807568877293527;
static double sqpii = 5.64189583547756286948E-1;
extern double PI;

extern double MAXNUM, MACHEP;

#define MAXAIRY 103.892

static unsigned short AN[32] = {
    0xb658,0x2537,0x2dae,0x3fd6,
    0x9067,0x871a,0x03e3,0x4028,
    0xe1e3,0x0de2,0x11e5,0x4053,
    0x073c,0xee40,0x02da,0x4065,
    0xfddf,0x5ba1,0xf834,0x4063,
    0xea4f,0x4f4c,0xa24f,0x4051,
    0x0f4d,0x5c2a,0x0d8d,0x402c,
    0x0000,0x0000,0x0000,0x3ff0,
};
static unsigned short AD[32] = {
    0x4d31,0x0262,0x29bc,0x3fe2,
    0x2ca5,0x0533,0x8334,0x402d,
    0x51a0,0xb04d,0x20e3,0x4055,
    0xb7b0,0xc730,0x2a2d,0x4066,
    0xfa61,0x9a9f,0x8782,0x4064,
    0xd35f,0xee91,0xde94,0x4051,
    0x9d81,0x950d,0x311b,0x402c,
    0x0000,0x0000,0x0000,0x3ff0,
};

static unsigned short APN[32] = {
    0xab3e,0x4d4c,0xa3ea,0x3fe3,
    0x2bcf,0xdc67,0x7dad,0x402d,
    0xa9a6,0x0724,0x83bd,0x4054,
    0xc9ba,0xba99,0x65e9,0x4065,
    0x64d7,0xcdc2,0xea2b,0x4063,
    0x1646,0x41d4,0x7e95,0x4051,
    0x4099,0x6aa7,0xe4e8,0x402b,
    0x0000,0x0000,0x0000,0x3ff0,
};
static unsigned short APD[32] = {
    0xd5b3,0xd288,0x6397,0x3fd5,
    0x327e,0xedc9,0x5caf,0x4026,
    0x97e6,0x1800,0xcb0e,0x4051,
    0xdbd1,0x1132,0xd8e6,0x4063,
    0x3316,0x0dcb,0x269b,0x4063,
    0xf72f,0xf9d0,0x2b36,0x4051,
    0x7982,0x4e35,0xb321,0x402b,
    0x0000,0x0000,0x0000,0x3ff0,
};

static unsigned short BN16[20] = {
    0x6751,0xe211,0x3518,0xbfd0,
    0x2383,0x7072,0x68bc,0x3fe2,
    0xcf29,0x6785,0x1d32,0xbfd5,
    0x78a8,0xa027,0x7f2a,0x3fb0,
    0xcd1b,0x2dba,0x5604,0xbf6f,
};
static unsigned short BD16[20] = {
    /*0x0000,0x0000,0x0000,0x3ff0,*/
    0xab58,0x891b,0xa09d,0xc01c,
    0x1101,0xfe0b,0x3539,0x4025,
    0x70e8,0xa9a7,0xee0b,0xc014,
    0x95ff,0xa6da,0xa2fc,0x3fee,
    0x86c9,0x8f8e,0x33d0,0xbfac,
};

static unsigned short BPPN[20] = {
    0x377b,0x9deb,0xca1d,0x3fdd,
    0xe420,0xc6be,0x7051,0xbff1,
    0x5ff3,0xf199,0x710c,0x3fe4,
    0xa8fa,0x8681,0x3c6f,0xbfc0,
    0xb896,0xb8ce,0x3b43,0x3f7f,
};
static unsigned short BPPD[20] = {
    /*0x0000,0x0000,0x0000,0x3ff0,*/
    0xbc45,0xb340,0x6996,0xc021,
    0xbb8b,0x2ea4,0xcc73,0x402b,
    0xed59,0xa04a,0x908c,0xc01c,
    0x70a9,0xf9a5,0x70fd,0x3ff5,
    0x52e8,0x1b60,0x13d0,0xbfb4,
};

static unsigned short AFN[36] = {
    0xe6fb,0xd50a,0xdb6c,0xbfc0,
    0x6852,0x9856,0x0bee,0xbfe4,
    0x9f7d,0xc2f7,0x2e59,0xbfe6,
    0xf40b,0x4bb3,0xe7ea,0xbfd1,
    0xbd8a,0xf47d,0x2f6e,0xbfa9,
    0xe090,0xc8d9,0xa401,0xbf70,
    0x009c,0xaf4b,0xe06e,0xbf24,
    0x366d,0x1d42,0x4a78,0xbec7,
    0xa2d2,0xf68e,0x041c,0xbe52,
};
static unsigned short AFD[36] = {
    /*0x0000,0x0000,0x0000,0x3ff0,*/
    0xedf2,0x2572,0xb64b,0x402a,
    0x7b1a,0x4478,0x575c,0x4040,
    0x3410,0xa3b7,0xbc98,0x403a,
    0x9873,0x2ac9,0x5fc8,0x4022,
    0x9319,0x39de,0x9acb,0x3ff7,
    0x5a2b,0xb404,0x9dac,0x3fbd,
    0xf617,0xe03a,0x08ca,0x3f72,
    0xe73b,0xaf76,0xc8d7,0x3f13,
    0x18a7,0xb995,0x52b9,0x3e9e,
};

static unsigned short AGN[44] = {
    0xbbde,0xddcf,0x3525,0x3f94,
    0x37b7,0x0064,0x07d5,0x3fd9,
    0x34eb,0x3a20,0x0d83,0x3ff1,
    0x1acb,0xa0ef,0x0dac,0x3fee,
    0xfe1d,0xcea8,0x7e69,0x3fd6,
    0x0978,0x21e9,0x3a41,0x3fb0,
    0x5043,0xf12f,0xfe99,0x3f77,
    0x17a2,0x600e,0x8976,0x3f32,
    0x574e,0x69f8,0x4f3d,0x3edd,
    0x11c8,0xbbad,0xca92,0x3e75,
    0xee7a,0x7d97,0x78a4,0x3df7,
};
static unsigned short AGD[40] = {
    /*0x0000,0x0000,0x0000,0x3ff0,*/
    0x6b40,0xf3d5,0x9e2b,0x4022,
    0x18d4,0xc0ef,0xd5d5,0x4033,
    0xdc35,0x7ea7,0x211b,0x402f,
    0xdbce,0x2b79,0xe84e,0x4015,
    0xece3,0xc195,0x8992,0x3fee,
    0xa9ee,0xed64,0x221d,0x3fb6,
    0x93bb,0x6be3,0xe704,0x3f70,
    0xa5a0,0xd603,0x8b61,0x3f1a,
    0x24e8,0xdb07,0xa845,0x3eb3,
    0x89d4,0x3dd5,0x1fc7,0x3e35,
};

static unsigned short APFN[36] = {
    0x5db5,0x8e7d,0xba0f,0x3fc7,
    0xd07e,0x3d14,0x5ff2,0x3fec,
    0x01af,0x11be,0x98b7,0x3fef,
    0x84a1,0x1397,0xadef,0x3fd9,
    0x33d1,0xeadc,0x2f0d,0x3fb2,
    0xa140,0xe347,0x3115,0x3f78,
    0x8059,0x5d03,0x8be8,0x3f2e,
    0x12af,0x9f80,0x2495,0x3ed1,
    0x7d86,0x654d,0xab6a,0x3e5a,
};
static unsigned short APFD[36] = {
    /*0x0000,0x0000,0x0000,0x3ff0,*/
    0xcc60,0x9628,0x781b,0x402d,
    0x0e31,0x2524,0xc56d,0x4042,
    0xffb8,0x09cc,0x773d,0x403f,
    0x03f7,0x5163,0xfe6b,0x4025,
    0xc9fd,0xc07a,0x9f21,0x3ffc,
    0xf796,0xe40e,0x2450,0x3fc2,
    0x351a,0x3a5a,0x48f2,0x3f76,
    0x63a1,0x7cfb,0xa059,0x3f18,
    0x1e2e,0x5a24,0xfdb8,0x3ea2,
};

static unsigned short APGN[44] = {
    0xaf5b,0x5f87,0x351f,0xbfa2,
    0x5c76,0x1ff7,0x64db,0xbfe4,
    0x7e49,0xc221,0x564a,0xbffb,
    0x0b07,0x7f6e,0x0916,0xbff8,
    0x6edb,0xd8b0,0x0910,0xbfe2,
    0x9903,0x0d8c,0x234b,0xbfba,
    0x50df,0x7f6c,0x6c54,0xbf83,
    0x2ad0,0x2424,0x2afa,0xbf3e,
    0xf631,0xbc17,0xf87a,0xbee7,
    0x6c10,0x501e,0xe81f,0xbe81,
    0x870d,0x5e46,0x5f45,0xbe03,
};
static unsigned short APGD[40] = {
    /*0x0000,0x0000,0x0000,0x3ff0,*/
    0x9812,0x060a,0xb7a2,0x4023,
    0xfc96,0x4724,0xa3e3,0x4035,
    0x819a,0xdb2c,0x5025,0x4031,
    0x94e2,0xd5cd,0xb702,0x4018,
    0x1eb1,0x4927,0x6a71,0x3ff1,
    0x7bc5,0x4ad7,0x78de,0x3fb9,
    0xc1d7,0x4b2b,0x991a,0x3f73,
    0xbe1c,0x0b16,0xf98f,0x3f1e,
    0x4ef3,0xfdde,0x10bf,0x3eb7,
    0x647e,0x9dc8,0xe834,0x3e38,
};



extern double fabs ( double );
extern double exp ( double );
extern double sqrt ( double );
extern double polevl ( double, void *, int );
extern double p1evl ( double, void *, int );
extern double sin ( double );
extern double cos ( double );


int airy( double x, double* ai, double* aip, double* bi, double* bip )
{
    double z, zz, t, f, g, uf, ug, k, zeta, theta;
    int domflg;
    
    domflg = 0;
    if( x > MAXAIRY )
    {
        *ai = 0;
        *aip = 0;
        *bi = MAXNUM;
        *bip = MAXNUM;
        return(-1);
    }
    
    if( x < -2.09 )
    {
        domflg = 15;
        t = sqrt(-x);
        zeta = -2.0 * x * t / 3.0;
        t = sqrt(t);
        k = sqpii / t;
        z = 1.0/zeta;
        zz = z * z;
        uf = 1.0 + zz * polevl( zz, AFN, 8 ) / p1evl( zz, AFD, 9 );
        ug = z * polevl( zz, AGN, 10 ) / p1evl( zz, AGD, 10 );
        theta = zeta + 0.25 * PI;
        f = sin( theta );
        g = cos( theta );
        *ai = k * (f * uf - g * ug);
        *bi = k * (g * uf + f * ug);
        uf = 1.0 + zz * polevl( zz, APFN, 8 ) / p1evl( zz, APFD, 9 );
        ug = z * polevl( zz, APGN, 10 ) / p1evl( zz, APGD, 10 );
        k = sqpii * t;
        *aip = -k * (g * uf + f * ug);
        *bip = k * (f * uf - g * ug);
        return(0);
    }
    
    if( x >= 2.09 )	/* cbrt(9) */
    {
        domflg = 5;
        t = sqrt(x);
        zeta = 2.0 * x * t / 3.0;
        g = exp( zeta );
        t = sqrt(t);
        k = 2.0 * t * g;
        z = 1.0/zeta;
        f = polevl( z, AN, 7 ) / polevl( z, AD, 7 );
        *ai = sqpii * f / k;
        k = -0.5 * sqpii * t / g;
        f = polevl( z, APN, 7 ) / polevl( z, APD, 7 );
        *aip = f * k;
        
        if( x > 8.3203353 )	/* zeta > 16 */
        {
            f = z * polevl( z, BN16, 4 ) / p1evl( z, BD16, 5 );
            k = sqpii * g;
            *bi = k * (1.0 + f) / t;
            f = z * polevl( z, BPPN, 4 ) / p1evl( z, BPPD, 5 );
            *bip = k * t * (1.0 + f);
            return(0);
        }
    }
    
    f = 1.0;
    g = x;
    t = 1.0;
    uf = 1.0;
    ug = x;
    k = 1.0;
    z = x * x * x;
    while( t > MACHEP )
    {
        uf *= z;
        k += 1.0;
        uf /=k;
        ug *= z;
        k += 1.0;
        ug /=k;
        uf /=k;
        f += uf;
        k += 1.0;
        ug /=k;
        g += ug;
        t = fabs(uf/f);
    }
    uf = c1 * f;
    ug = c2 * g;
    if( (domflg & 1) == 0 )
        *ai = uf - ug;
    if( (domflg & 2) == 0 )
        *bi = sqrt3 * (uf + ug);
    
    /* the deriviative of ai */
    k = 4.0;
    uf = x * x/2.0;
    ug = z/3.0;
    f = uf;
    g = 1.0 + ug;
    uf /= 3.0;
    t = 1.0;
    
    while( t > MACHEP )
    {
        uf *= z;
        ug /=k;
        k += 1.0;
        ug *= z;
        uf /=k;
        f += uf;
        k += 1.0;
        ug /=k;
        uf /=k;
        g += ug;
        k += 1.0;
        t = fabs(ug/g);
    }
    
    uf = c1 * f;
    ug = c2 * g;
    if( (domflg & 4) == 0 )
        *aip = uf - ug;
    if( (domflg & 8) == 0 )
        *bip = sqrt3 * (uf + ug);
    return(0);
}
